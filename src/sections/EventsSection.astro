---
import EventAccordion from "@components/EventAccordion.astro"
import events from "@/data/events.json";
const eventsData = events.events;
// Ordenar eventos por fecha ascendente
eventsData.sort((a, b) => {
    const dateA = new Date(`${a.date.year}-${a.date.month}-${a.date.day}T${a.date.time}:00`);
    const dateB = new Date(`${b.date.year}-${b.date.month}-${b.date.day}T${b.date.time}:00`);
    return dateA.getTime() - dateB.getTime();
});

const initialEventsCount = 4;
const hasMoreEvents = eventsData.length > initialEventsCount;
---

<section class="opacity-0 flex flex-col max-w-[80%] md:max-w-[60%] mx-auto my-32 gap-4">
    <h2 class="text-center font-primary uppercase text-text text-4xl">Próximos eventos</h2>
    <div class="gap-4 grid grid-cols-1" id="events-container">
        {eventsData.map((event, index) => (
            <div class={`event-item ${index >= initialEventsCount ? 'hidden' : ''}`}>
                <EventAccordion 
                    title={event.title} 
                    description={event.description} 
                    targetDate={`${event.date.year}-${event.date.month}-${event.date.day}T${event.date.time}:00`}
                    image={event.image ?? ""}
                    location={event.location ?? ""}
                />
            </div>
        ))}
    </div>
    
    {hasMoreEvents && (
        <button 
            id="show-more-btn"
            class="mt-4 uppercase px-6 py-3 bg-gold text-bg font-bold rounded-lg hover:bg-gold-alt transition-all duration-300 hover:scale-105 active:scale-95 self-center cursor-pointer"
        >
            Mostrar todos
        </button>
    )}
    
    <p id="github-issue-text" class={`text-center text-sm text-text60 opacity-0 ${hasMoreEvents ? 'hidden' : ''}`}>
        ¿Echas de menos algún evento? crea un issue 
        <a href="https://github.com/Tonips22/happy-new-year/issues" target="_blank" rel="noopener noreferrer" class="underline text-gold hover:text-gold-alt">aquí</a>.
    </p>
</section>

<style>
    section {
        animation: fade-in-up 0.5s ease forwards;
        animation-delay: 0.4s;
    }

    .event-item {
        animation: fade-in-up 0.3s ease forwards;
    }

    #github-issue-text:not(.hidden) {
        animation: fade-in-up 0.3s ease forwards;
    }
</style>

<script>
    function initShowMoreButton() {
        const showMoreBtn = document.getElementById('show-more-btn');
        const githubText = document.getElementById('github-issue-text');
        
        if (showMoreBtn && !showMoreBtn.dataset.initialized) {
            showMoreBtn.dataset.initialized = 'true';
            
            showMoreBtn.addEventListener('click', () => {
                const hiddenEvents = document.querySelectorAll('.event-item.hidden');
                
                hiddenEvents.forEach((event, index) => {
                    setTimeout(() => {
                        event.classList.remove('hidden');
                    }, index * 100); // Animación escalonada
                });
                showMoreBtn.style.display = 'none';
                
                // Mostrar el texto del issue después de todos los eventos con animación
                if (githubText) {
                    setTimeout(() => {
                        githubText.classList.remove('hidden');
                    }, hiddenEvents.length * 100);
                }
            });
        }
    }

    // Inicializar en carga inicial
    document.addEventListener('DOMContentLoaded', initShowMoreButton);
    
    // Reinicializar después de View Transitions
    document.addEventListener('astro:page-load', initShowMoreButton);
</script>