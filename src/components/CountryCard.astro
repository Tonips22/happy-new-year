---
interface Props {
    name: string;
    flag: string;
    timezone: string; // Ej: 'Europe/Madrid', 'America/New_York', 'Asia/Tokyo'
}
const { name, flag, timezone } = Astro.props;

// Calcular fecha objetivo: 31 de diciembre 2025 a las 23:59:59 en la zona horaria del país
const year = new Date().getFullYear();
// Crear fecha en UTC y luego ajustarla según la zona horaria
const targetDate = new Date(`${year + 1}-01-01T00:00:00`);

// Calcular valores iniciales para SSR
const now = new Date();
const diff = targetDate.getTime() - now.getTime();
const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
const segundos = Math.floor((diff % (1000 * 60)) / 1000);

// Generar ID único para este contador
const counterId = `country-${name.toLowerCase().replace(/\s+/g, '-')}`;
---

<article 
    class="flex items-center justify-between border border-gold rounded-lg p-4 gap-4 hover:border-gold-alt hover:scale-105 transition-all duration-300 cursor-default"
    data-timezone={timezone}
    data-country-id={counterId}
>
    <div class="flex items-center gap-4">
        <img src={flag} alt={`Bandera de ${name}`} class="w-8 h-6 object-cover rounded"/>
        <h2 class="uppercase font-bold text-sm md:text-base">{name}</h2>
    </div>
    <p class="text-sm text-text60">
        <span class="text-gold-alt font-bold" data-days>{dias.toString().padStart(2, '0')}</span>d
        <span class="text-gold-alt font-bold" data-hours>{horas.toString().padStart(2, '0')}</span>h
        <span class="text-gold-alt font-bold" data-minutes>{minutos.toString().padStart(2, '0')}</span>m
        <span class="text-gold-alt font-bold" data-seconds>{segundos.toString().padStart(2, '0')}</span>s
    </p>
</article>

<script>
    function initCountryCounters() {
        const cards = document.querySelectorAll('[data-country-id]');
        
        cards.forEach((card) => {
            const timezone = card.getAttribute('data-timezone') as string;
            
            // Función para actualizar el contador de este país
            function updateCounter() {
                const now = new Date();
                
                // Obtener partes de la fecha actual en la zona horaria del país
                const formatter = new Intl.DateTimeFormat('en-US', {
                    timeZone: timezone,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                const parts = formatter.formatToParts(now);
                const tzYear = parseInt(parts.find(p => p.type === 'year')!.value);
                const tzMonth = parseInt(parts.find(p => p.type === 'month')!.value);
                const tzDay = parseInt(parts.find(p => p.type === 'day')!.value);
                const tzHour = parseInt(parts.find(p => p.type === 'hour')!.value);
                const tzMinute = parseInt(parts.find(p => p.type === 'minute')!.value);
                const tzSecond = parseInt(parts.find(p => p.type === 'second')!.value);
                
                // Crear fecha local del país
                const nowInTz = new Date(tzYear, tzMonth - 1, tzDay, tzHour, tzMinute, tzSecond);
                
                // Crear fecha objetivo: 1 de enero del próximo año en esa zona horaria
                const targetInTz = new Date(tzYear + 1, 0, 1, 0, 0, 0);
                
                // Calcular diferencia temporal
                const offset = now.getTime() - nowInTz.getTime();
                const targetInUTC = targetInTz.getTime() + offset;
                
                const diff = targetInUTC - now.getTime();
                
                if (diff <= 0) {
                    // Ya es año nuevo en este país
                    card.querySelector('[data-days]')!.textContent = '00';
                    card.querySelector('[data-hours]')!.textContent = '00';
                    card.querySelector('[data-minutes]')!.textContent = '00';
                    card.querySelector('[data-seconds]')!.textContent = '00';
                    return;
                }
                
                const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
                const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const segundos = Math.floor((diff % (1000 * 60)) / 1000);
                
                // Actualizar DOM
                card.querySelector('[data-days]')!.textContent = dias.toString().padStart(2, '0');
                card.querySelector('[data-hours]')!.textContent = horas.toString().padStart(2, '0');
                card.querySelector('[data-minutes]')!.textContent = minutos.toString().padStart(2, '0');
                card.querySelector('[data-seconds]')!.textContent = segundos.toString().padStart(2, '0');
            }
            
            // Actualizar inmediatamente y luego cada segundo
            updateCounter();
            setInterval(updateCounter, 1000);
        });
    }
    
    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCountryCounters);
    } else {
        initCountryCounters();
    }
</script>