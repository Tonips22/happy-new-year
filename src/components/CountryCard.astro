---
interface Props {
    name: string;
    flag: string;
    timezone: string; // Ej: 'Europe/Madrid', 'America/New_York', 'Asia/Tokyo'
    utcOffset: number; // Offset en horas respecto a UTC (ej: +1, -5, +9)
}
const { name, flag, timezone, utcOffset } = Astro.props;

// Generar ID único para este contador (eliminar caracteres especiales)
const counterId = `country-${name.toLowerCase().replace(/[.\s]+/g, '-')}`;
---

<article 
    class="country-card flex items-center justify-between border border-gold rounded-lg p-4 gap-4 hover:border-gold-alt hover:scale-105 transition-all duration-300 cursor-default"
    data-timezone={timezone}
    data-country-id={counterId}
    data-utc-offset={utcOffset}
>
    <div class="flex items-center gap-4">
        <img src={flag} alt={`Bandera de ${name}`} class="w-8 h-6 object-cover rounded"/>
        <h2 class="uppercase font-bold text-sm md:text-base">{name}</h2>
    </div>
    
    <!-- Contenedor del contador (SimplyCountdown lo llenará) -->
    <div class="country-countdown" id={counterId}></div>
    
    <!-- Icono de check (oculto por defecto, se muestra cuando termina el countdown) -->
    <svg 
        class="country-check hidden" 
        xmlns="http://www.w3.org/2000/svg" 
        width="24" 
        height="24" 
        viewBox="0 0 24 24" 
        fill="none" 
        stroke="currentColor" 
        stroke-width="2" 
        stroke-linecap="round" 
        stroke-linejoin="round"
    >
        <path d="M21.801 10A10 10 0 1 1 17 3.335"/>
        <path d="m9 11 3 3L22 4"/>
    </svg>
</article>

<style>
    .country-countdown {
        display: flex;
        gap: 0.25rem;
        font-size: 0.875rem;
        min-width: 140px;
        text-align: right;
        justify-content: flex-end;
    }

    .country-countdown :global(.simply-section) {
        display: inline;
    }

    .country-countdown :global(.simply-amount) {
        font-weight: 700 !important;
        color: var(--gold-alt) !important;
        font-size: 0.875rem !important;
        display: inline-block !important;
        min-width: 1.25em !important;
        text-align: right !important;
    }

    .country-countdown :global(.simply-word) {
        font-weight: 400 !important;
        color: var(--text60) !important;
        font-size: 0.875rem !important;
        margin-right: 0.125rem !important;
    }

    .country-check {
        color: var(--gold-alt);
        flex-shrink: 0;
    }
</style>

<script>
    import simplyCountdown from 'simplycountdown.js';

    function initCountryCounters() {
        const cards = document.querySelectorAll('[data-country-id]');
        
        cards.forEach((card) => {
            const countryId = card.getAttribute('data-country-id') as string;
            const utcOffset = parseFloat(card.getAttribute('data-utc-offset') || '0');
            const countdownElement = card.querySelector(`#${countryId}`) as HTMLElement;
            const checkIcon = card.querySelector('.country-check') as HTMLElement;
            
            if (!countdownElement) return;

            // Limpiar contenido previo
            countdownElement.innerHTML = '';

            // Calcular fecha objetivo: 1 de enero 2026 a las 00:00:00 en la zona horaria del país
            const currentYear = new Date().getFullYear();
            const nextYear = currentYear + 1;
            
            // Calcular cuándo es medianoche del 1 de enero en ese país, en hora local del navegador
            // Por ejemplo, si el offset es -5, medianoche allí es 5 horas después que UTC
            // Si el offset es +9, medianoche allí es 9 horas antes que UTC
            const targetDateUTC = Date.UTC(nextYear, 0, 1, 0, 0, 0);
            // 29 Noviembre 2025 a las 21:30 en la zona horaria del país
            // const targetDateUTC = Date.UTC(currentYear, 10, 29, 20, 30, 0);
            // Restar el offset para obtener el momento en hora local del navegador
            const targetTimestamp = targetDateUTC - (utcOffset * 60 * 60 * 1000);
            const targetDate = new Date(targetTimestamp);

            // Inicializar SimplyCountdown con la fecha en hora local
            simplyCountdown(`#${countryId}`, {
                year: targetDate.getFullYear(),
                month: targetDate.getMonth() + 1,
                day: targetDate.getDate(),
                hours: targetDate.getHours(),
                minutes: targetDate.getMinutes(),
                seconds: targetDate.getSeconds(),

                // Palabras cortas para el formato compacto
                words: {
                    days: {
                        lambda: () => 'd',
                        root: 'd'
                    },
                    hours: {
                        lambda: () => 'h',
                        root: 'h'
                    },
                    minutes: {
                        lambda: () => 'm',
                        root: 'm'
                    },
                    seconds: {
                        lambda: () => 's',
                        root: 's'
                    }
                },

                // Configuración
                plural: false,
                inline: false,
                enableUtc: false,
                zeroPad: true,
                countUp: false,
                removeZeroUnits: false,
                refresh: 1000,

                // Clases
                sectionClass: 'simply-section',
                amountClass: 'simply-amount',
                wordClass: 'simply-word',

                // Callback cuando termina
                onEnd: () => {
                    if (countdownElement && checkIcon) {
                        countdownElement.style.display = 'none';
                        checkIcon.classList.remove('hidden');
                    }
                }
            });
        });
    }
    
    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCountryCounters);
    } else {
        initCountryCounters();
    }

    // Reinicializar después de navegaciones con View Transitions
    document.addEventListener('astro:page-load', initCountryCounters);
</script>