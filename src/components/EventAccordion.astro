---
import ArrowDown from '@/assets/arrow-down.svg';
interface Props {
  title: string;
  description: string;
  image: string;
  targetDate: string; // Formato: 'YYYY-MM-DDTHH:mm:ss' o 'YYYY-MM-DD'
  timezone?: string; // Opcional, por defecto usa la zona horaria local
  location?: string;
}
const { title, description, image, targetDate, timezone = 'Europe/Madrid', location } = Astro.props;

// Calcular valores iniciales para SSR
const target = new Date(targetDate);
const now = new Date();
const diff = target.getTime() - now.getTime();
const dias = Math.max(0, Math.floor(diff / (1000 * 60 * 60 * 24)));
const horas = Math.max(0, Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)));
const minutos = Math.max(0, Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)));
const segundos = Math.max(0, Math.floor((diff % (1000 * 60)) / 1000));

// Generar ID único
const eventId = `event-${title.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')}`;
---

<article 
  class="event-accordion min-h-[135px] md:min-h-auto border-2 border-gold rounded-xl overflow-hidden transition-all duration-300 hover:border-gold-alt hover:scale-105 hover:shadow-[0_4px_12px_rgba(255,215,0,0.2)] relative group"
  data-event-id={eventId}
  data-target-date={targetDate}
  data-timezone={timezone}
>
    {image && (
          <img src={image} alt={title} loading="lazy" class="event-accordion-image absolute top-0 -z-10 left-0 w-full h-full object-cover" />
    )}
  <!-- Header clickeable -->
  <button class="accordion-header w-full bg-transparent border-none p-6 cursor-pointer flex items-center justify-between gap-4">

    <div class="flex flex-col gap-2">
        <h3 class="font-primary text-lg md:text-xl font-bold text-text text-left">{title}</h3>

        <div class="flex items-center">
            <!-- Contenedor para SimplyCountdown -->
            <div class="event-countdown" id={eventId}></div>
        </div>
    </div>
    
    <ArrowDown class="accordion-icon text-base text-gold transition-transform duration-300 shrink-0 group-hover:text-gold-alt" />
  </button>

  <!-- Panel expandible -->
  <div class="accordion-panel grid transition-[grid-template-rows] duration-300 ease-in-out">
    <div class="overflow-hidden">
      <div class="panel-content p-6 border-t border-gold25">
        <p class="text-text leading-relaxed mb-4">{description}</p>
        <div>
          <time datetime={targetDate} class="text-gold font-semibold text-sm capitalize">
            {new Date(targetDate).toLocaleDateString('es-ES', { 
              weekday: 'long', 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })}
          </time>
        </div>
      </div>
    </div>
  </div>
</article>

<style>
  /* Solo estilos que no se pueden hacer con Tailwind */
  .accordion-panel {
    grid-template-rows: 0fr;
  }

  .event-accordion.active .accordion-panel {
    grid-template-rows: 1fr;
  }

  .event-accordion.active .accordion-icon {
    transform: rotate(180deg);
  }

  @media (max-width: 768px) {
    .header-content {
      flex-direction: column;
      align-items: flex-start;
    }

    .header-content > div:last-child {
      width: 100%;
    }

    .header-content span.font-mono {
      width: 100%;
      text-align: center;
    }
  }

  .event-accordion-image {
    /* Opción 1: Tono amarillo/dorado suave */
    filter: sepia(0.6) saturate(1.5) brightness(0.9);
    
    /* Opción 2: Amarillo más intenso - descomenta para usar */
    /* filter: sepia(0.8) saturate(2) hue-rotate(-10deg) brightness(0.85); */
    
    /* Opción 3: Tono dorado cálido - descomenta para usar */
    /* filter: sepia(0.7) saturate(1.8) hue-rotate(20deg) brightness(0.9) contrast(1.1); */
    
    opacity: 0.2;
    transition: filter 0.3s ease, opacity 0.3s ease;
  }

  .event-accordion:hover .event-accordion-image {
    opacity: 0.1;
    filter: sepia(0.5) saturate(1.3) brightness(1);
  }

  /* Estilos para SimplyCountdown */
  .event-countdown {
    display: inline-flex;
    gap: 0;
    font-size: 0.875rem;
  }

  .event-countdown :global(.simply-section) {
    display: inline-flex;
    align-items: baseline;
    gap: 0;
  }

  .event-countdown :global(.simply-amount) {
    font-weight: 700 !important;
    color: var(--gold-alt) !important;
    font-size: 0.875rem !important;
  }

  .event-countdown :global(.simply-word) {
    font-weight: 400 !important;
    color: var(--text60) !important;
    font-size: 0.875rem !important;
    margin-right: 0.125rem !important;
  }

  /* Oscurecer evento expirado */
  .event-accordion.expired {
    opacity: 0.5;
    filter: grayscale(0.7);
    pointer-events: none;
  }

  .event-accordion.expired .accordion-header {
    cursor: not-allowed;
  }

  @media (prefers-reduced-motion: reduce) {
    .event-accordion,
    .accordion-header,
    .accordion-icon,
    .accordion-panel {
      transition: none !important;
    }
  }
</style>

<script>
  import simplyCountdown from 'simplycountdown.js';

  function initEventAccordions() {
    const accordions = document.querySelectorAll('[data-event-id]');
    
    accordions.forEach((accordion) => {
      const eventId = accordion.getAttribute('data-event-id') as string;
      const targetDate = accordion.getAttribute('data-target-date') as string;
      const countdownElement = accordion.querySelector(`#${eventId}`) as HTMLElement;
      
      if (!countdownElement) return;

      // Verificar si ya está inicializado el countdown
      if (accordion.hasAttribute('data-countdown-initialized')) {
        return;
      }
      accordion.setAttribute('data-countdown-initialized', 'true');

      // Limpiar contenido previo
      countdownElement.innerHTML = '';

      // Parsear fecha objetivo
      const target = new Date(targetDate);

      // Inicializar SimplyCountdown
      simplyCountdown(`#${eventId}`, {
        year: target.getFullYear(),
        month: target.getMonth() + 1,
        day: target.getDate(),
        hours: target.getHours(),
        minutes: target.getMinutes(),
        seconds: target.getSeconds(),

        // Palabras cortas
        words: {
          days: {
            lambda: () => 'd',
            root: 'd'
          },
          hours: {
            lambda: () => 'h',
            root: 'h'
          },
          minutes: {
            lambda: () => 'm',
            root: 'm'
          },
          seconds: {
            lambda: () => 's',
            root: 's'
          }
        },

        // Configuración
        plural: false,
        inline: false,
        enableUtc: false,
        zeroPad: true,
        countUp: false,
        removeZeroUnits: false,
        refresh: 1000,

        // Clases
        sectionClass: 'simply-section',
        amountClass: 'simply-amount',
        wordClass: 'simply-word',

        // Callback cuando termina
        onEnd: () => {
          // Oscurecer la card cuando expira
          accordion.classList.add('expired');
        }
      });
    });
  }

  function setupAccordionListeners() {
    // Usar delegación de eventos en el documento
    document.addEventListener('click', (e) => {
      const header = (e.target as HTMLElement).closest('.accordion-header');
      if (!header) return;

      const accordion = header.closest('[data-event-id]');
      if (!accordion) return;

      e.preventDefault();
      
      const isActive = accordion.classList.contains('active');
      
      // Cerrar todos los demás
      document.querySelectorAll('[data-event-id].active').forEach((other) => {
        if (other !== accordion) {
          other.classList.remove('active');
        }
      });
      
      // Toggle el actual
      accordion.classList.toggle('active', !isActive);
    });
  }
  
  // Inicializar cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initEventAccordions();
      setupAccordionListeners();
    });
  } else {
    initEventAccordions();
    setupAccordionListeners();
  }

  // Reinicializar después de navegaciones con View Transitions
  document.addEventListener('astro:page-load', () => {
    // Limpiar atributos de inicialización para permitir reinicialización
    document.querySelectorAll('[data-event-id][data-countdown-initialized]').forEach(el => {
      el.removeAttribute('data-countdown-initialized');
    });
    initEventAccordions();
  });
</script>