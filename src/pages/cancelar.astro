---
// src/pages/cancelar.astro
import Layout from '@layouts/Layout.astro';
import { supabaseAdmin } from '@api/supabase';

const token = Astro.url.searchParams.get('token');
let success = false;
let error = '';

if (Astro.request.method === 'POST' && token) {
  try {
    const { error: dbError } = await supabaseAdmin
      .from('subscribers')
      .delete()
      .eq('unsubscribe_token', token);

    if (dbError) throw dbError;
    success = true;
  } catch (e) {
    console.error('Error cancelando:', e);
    error = 'Error al procesar. Inténtalo de nuevo.';
  }
}
---

<Layout 
  title="Cancelar suscripción - Feliz Año Nuevo"
  description="Gestiona tu suscripción"
>
  <main class="min-h-screen flex items-center justify-center p-6">
    <div class="max-w-md w-full bg-linear-to-r from-gold/10 to-gold-alt/10 rounded-lg p-8 text-center border border-gold/20">
      
      {!token ? (
        <div>
          <h1 class="text-3xl font-bold mb-4 flex items-center justify-center gap-2">
            Token inválido
          </h1>
          <p class="mb-6 opacity-80">
            El enlace de cancelación no es válido o ha expirado.
          </p>
          <a 
            href="/" 
            class="inline-block px-6 py-3 bg-gold hover:bg-gold-alt text-black font-bold rounded-lg transition-colors"
          >
            Volver al inicio
          </a>
        </div>
      ) : success ? (
        <div>
          <h1 class="text-3xl font-bold mb-4 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-icon lucide-check size-12 text-gold"><path d="M20 6 9 17l-5-5"/></svg>
            Cancelado
            </h1>
          <p class="mb-6 opacity-80">
            Tu email ha sido eliminado de nuestra lista.<br>
            ¡Esperamos verte el próximo año!
          </p>
          <a 
            href="/" 
            class="inline-block px-6 py-3 bg-gold hover:bg-gold-alt text-black font-bold rounded-lg transition-colors"
          >
            Volver al inicio
          </a>
        </div>
      ) : (
        <form method="POST">
          <h1 class="text-3xl font-bold mb-4">¿Cancelar suscripción?</h1>
          <p class="mb-6 opacity-80">
            Ya no recibirás el email especial de Año Nuevo.
          </p>
          
          {error && (
            <p class="mb-4 text-red-400 font-medium">{error}</p>
          )}
          
          <div class="flex gap-3 justify-center">
            <a 
              href="/" 
              class="px-6 py-3 bg-white/10 hover:bg-white/20 rounded-lg transition-colors font-medium"
            >
              No, volver
            </a>
            <button 
              type="submit"
              class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors font-bold"
            >
              Sí, cancelar
            </button>
          </div>
        </form>
      )}
      
    </div>
  </main>
</Layout>